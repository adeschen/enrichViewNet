# Workflow derived from https://github.com/r-lib/actions/tree/v2/examples
# Need help debugging build failures? Start at https://github.com/r-lib/actions#where-to-find-help
on:
  push:
    branches: 
        - devel
  pull_request:
    branches: 
        - devel

name: test-coverage

jobs:
  test-coverage:
    test-coverage:
      runs-on: macOS-latest
        steps:
          - name: Checkout
            uses: actions/checkout@v3

          - uses: r-lib/actions/setup-r@v1

          - uses: r-lib/actions/setup-pandoc@v1

          - name: Query dependencies
                run: |
                    install.packages('remotes')
                    saveRDS(remotes::dev_package_deps(dependencies = TRUE), ".github/depends.Rds", version = 2)
                    writeLines(sprintf("R-%i.%i", getRversion()$major, getRversion()$minor), ".github/R-version")
                shell: Rscript {0}

          - name: Restore R package cache
            uses: actions/cache@v2
            with:
             path: ${{ env.R_LIBS_USER }}
             key: ${{ runner.os }}-${{ hashFiles('.github/R-version') }}-1-${{ hashFiles('.github/depends.Rds') }}
             restore-keys: ${{ runner.os }}-${{ hashFiles('.github/R-version') }}-1-

          - name: Install dependencies
            run: |
            install.packages(c("remotes"))
            remotes::install_deps(dependencies = TRUE)
            remotes::install_cran("covr")
            shell: Rscript {0}

          - name: Test coverage
            run: covr::codecov()
            shell: Rscript {0}
  
         - name: Upload coverage to Codecov
           uses: codecov/codecov-action@v4
           env:
             CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
           
  